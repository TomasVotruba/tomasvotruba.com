---
layout: post
title: "How to Require Minimal Code Coverage for Github Pull-Requests with Coveralls"
perex: '''
    Do you maintain tested open-source project? Are you sad of your code-coverage decreasing over time in wave of pull-requests? <strong>Are you tired of telling "could you add tests"</strong>?
    <br><br>
    I will show you, how to let computer do this job for you.
'''
lang: en
---

Few years ago I've read a post about [automated code coverage check with PHPUnit and custom script](https://ocramius.github.io/blog/automated-code-coverage-check-for-github-pull-requests-with-travis/) by amazing Marco Pivetta ([@ocramius](https://twitter.com/ocramius)). 

In the post he explain, **how important is code coverage for code quality of open-source projects**:

> "[Code Coverage] is not an universal metric to define if our code works, and there is tons of examples of how your code can still be buggy even if every line of code was executed at least once. It should anyway not be ignored, and it is up to us to decide how hard we want to test each part of our application."

### He shows setup for Travis CI, that will

- generate coverage.xml with phpunit 
- computed total coverage in % with custom PHP script
- check it against your minimal requirement
- fails CI if it is lower than that
 
<img src="/assets/images/posts/2017/coveralls/coverage-checker.png" class="thumbnail">

Simple setup to let computer handle "please, add tests" response for you.

## Why it is Useful?

- You **move responsibility to a tool**, so you don't have to check code coverage for every project of yours manually. **CI looks after  it for you.**
- "Setup and forget."
- You don't have to explain at PRs, that "tests are missing". In my experience, less people read "CONTRIBUTING.md" than Travis CI fail report.
- Let's be honest - do you check your coding standards manually? If so, [start with this](https://github.com/symplify/EasyCodingStandard).


## 3 Steps to Automate Minimal Coverage Check With Coveralls 

Nowadays, we can make use of Coveralls CI instead of using own script or PHPUnit Listener ([thanks Macro](https://ocramius.github.io/blog/automated-code-coverage-check-for-github-pull-requests-with-travis/#comment-3322754327)). 
 
Here is how:

### 1. Create `.coveralls.yml`

```yaml
service_name: travis-ci
coverage_clover: coverage.xml # file generated by phpunit
json_path: coverage.json # file generated by php-coveralls
```

### 2. Send `coverage.xml` to Coveralls in `.travis.yml` 

If you already know how to generate coverage in with `phpunit`, **you can skip to `after_script` section**. There you'll find part with Coveralls setup.

```yaml
language: php

php:
  - 7.1

install:
  - composer install

script:
  - vendor/bin/phpunit --coverage-clover coverage.xml

after_script:
  # upload coverage.xml file to Coveralls to analyze it
  # minimal required coverage is set to 80+ %
  - wget https://github.com/satooshi/php-coveralls/releases/download/v1.0.1/coveralls.phar
  - php coveralls.phar --verbose
```

Performance note: This is the simplest setup with single build. If you run more builds with various PHP versions or ENV values, [you should run coverage only once](https://github.com/Symplify/Symplify/blob/e6ef5aeef11fc292841f204bd7ddcd2a55aace12/.travis.yml#L3-L30), because it uses `xdebug` extension and thus is very slow.

### 3. Setup Minimal Require Code Coverage in Coveralls.io

Add your repository on [Coveralls.io](https://coveralls.io), go to "Settings" and find "Coverage Treshold fo Failure" item.

<img src="/assets/images/posts/2017/coveralls/coveralls-treshold.png" class="thumbnail">

**There you can put a value you're ok with**. No need to push yourself to hard.
I personally start with coverage bit bellow current level.

That's all setup you need.

 
## WTFs You Might Meet

### I cannot see Coveralls is checks like Travis or Scrutinizer

<img src="/assets/images/posts/2017/coveralls/build-checks-scrutinizer.png" class="thumbnail">

Don't worry, it's there. It will appear when Travis will upload `coverage.xml` to it:
 
```yaml
after_script:
  # ... 
  - php coveralls.phar --verbose
```

### There is Actually no Report about The Limit in Pull Request

If build fails due to low coverage, Coveralls actually doesn't show *the number* you need to keep up with.

**This is the reason I've put a note to `.travis.yml` so people know**:

```yaml
after_script:
  # upload coverage.xml file to Coveralls to analyze it
  # minimal required coverage is set to 80+ %
```

And yes, [there is issue for that](https://github.com/lemurheavy/coveralls-public/issues/982). Feel free to up vote it or suggest a better solution.


### What are Takeways

- **Use CI where you can save your attention leaks**. You'll have more time for your friends, family and other joys of life, like coding.
- **Ask in comments under old posts**, if there is any better solution. There usually is.
- Setup and forget this post.


Enjoy your day!