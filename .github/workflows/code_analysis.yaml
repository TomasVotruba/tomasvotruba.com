name: "Code Analysis"

on:
    pull_request: null

permissions:
    contents: "read"

concurrency:
    group: "${{ github.workflow }}-${{ github.ref }}"
    cancel-in-progress: true

jobs:
    coding_standards:
        name: "Coding Standards"
        runs-on: "ubuntu-latest"
        steps:
            -
                name: "Checkout repository"
                uses: "actions/checkout@v3"
            -
                name: "Set up PHP"
                uses: "shivammathur/setup-php@v2"
                with:
                    php-version: "8.1"
                    extensions: "mbstring"
                    coverage: "none"
            -
                name: "Install dependencies"
                uses: "ramsey/composer-install@v2"
            -
                name: "ECS"
                run: "composer run fix-cs --ansi"

    static_analysis:
        name: "Static Analysis"
        runs-on: "ubuntu-latest"
        steps:
            -
                name: "Checkout repository"
                uses: "actions/checkout@v3"
            -
                name: "Set up PHP"
                uses: "shivammathur/setup-php@v2"
                with:
                    php-version: "8.1"
                    extensions: "mbstring"
                    coverage: "none"
            -
                name: "Install dependencies"
                uses: "ramsey/composer-install@v2"
            -
                name: "Perform static analysis"
                run: "composer run phpstan --ansi"

    unit_tests:
        name: "Unit tests"
        runs-on: "ubuntu-latest"
        steps:
            -
                name: "Checkout repository"
                uses: "actions/checkout@v3"
            -
                name: "Set up PHP"
                uses: "shivammathur/setup-php@v2"
                with:
                    php-version: "8.1"
                    extensions: "mbstring"
                    coverage: "xdebug"
            -
                name: "Install dependencies"
                uses: "ramsey/composer-install@v2"
            -
                name: "Set up environment variables"
                run: "cp .env.local .env"
            -
                name: "Execute unit tests"
                run: "composer exec -- phpunit"
